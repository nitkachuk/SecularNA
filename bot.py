import asyncio
from telegram import Bot
from g4f.client import Client
import unicodedata
import re

import os
import datetime

import sys
from replacements import replacements, doReplacements # type: ignore

def has_glyphs(text):
    for char in text:
        if unicodedata.category(char) == 'Lo':
            return True
    return False

def escape_markdown_v2(text):
    escape_chars = [  '[', ']', '(', ')', '~', '‚ìÉ', '>', '#', '+',
                      '-', '=', '|', '{', '}', '.', ',', '!', '\\'  ]
    
    for char in escape_chars:
        pattern = re.escape(char)
        
        if char == '\\':
            replacement = '\\\\'
        else:
            replacement = '\\' + char
        text = re.sub(pattern, replacement, text)

    text = text.replace('\\\\', '\\')
    return text

def escape_system_text(text):
    text = text.replace( '_{"code":200,"status":true,"model":"gpt-3.5-turbo","gpt":"', '')
    text = text.replace( '","original":null}', '')
    return text
    

def get_text():
    # —á–∞—Å—ã –∑–∞–ø—É—Å–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞ –Ω–∞ –≥–∏—Ç—Ö–∞–±–µ
    send_hour = 17
    send_minute = 0
    
    current_hour = datetime.datetime.now().hour
    current_minute = datetime.datetime.now().minute

    if current_hour > send_hour or (current_hour == send_hour and current_minute >= send_minute):
        today = datetime.date.today() + datetime.timedelta(days=1)
    else:
        today = datetime.date.today()

    current_day = today.day
    current_month = today.month

    folder_path = 'book'

    month_folder_path = os.path.join(folder_path, str(current_month))

    today_file = f"{current_day}.txt"

    if os.path.exists(month_folder_path):
        file_path = os.path.join(month_folder_path, today_file)

        if os.path.exists(file_path):
            with open(file_path, 'r', encoding='utf-8') as file:
                content = file.read()
                
                paragraphs = content.split('\n\n')

                p_lines = paragraphs[0].split('\n')
                p_lines[0] = f"{p_lines[0]}"        # –¥–∞—Ç–∞
                p_lines[1] = f"__{p_lines[1]}__"        # –∑–∞–≥–æ–ª–æ–≤–æ–∫
                p_lines[3] = f"_{p_lines[3]}_"    # —Ü–∏—Ç–∞—Ç–∞
                p_lines[4] = f"*{p_lines[4]}*"      # –∏—Å—Ç–æ—á–Ω–∏–∫

                paragraphs[0] = '\n'.join(p_lines)
                paragraphs[2] = paragraphs[2].replace("–¢–û–õ–¨–ö–û –°–ï–ì–û–î–ù–Ø:", "*–¢–û–õ–¨–ö–û –°–ï–ì–û–î–ù–Ø:*")

                largest_paragraph = max(paragraphs, key=len)
                lines = largest_paragraph.splitlines()
                formatted_paragraph = '\n' + '\n\n'.join(lines) + '\n'
                paragraphs[paragraphs.index(largest_paragraph)] = formatted_paragraph

                final_content = '\n\n'.join(paragraphs)

                return escape_markdown_v2( final_content )
        else:
            return f"–§–∞–π–ª –¥–ª—è {current_day} —á–∏—Å–ª–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–∞–ø–∫–µ –º–µ—Å—è—Ü–∞ {current_month}."
    else:
        return f"–ü–∞–ø–∫–∞ –¥–ª—è –º–µ—Å—è—Ü–∞ {current_month} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –ø–∞–ø–∫–µ 'book'."
    

async def main():
    bot_token = os.getenv('TELEGRAM_TOKEN')
    bot = Bot(token=bot_token)


    # —É–Ω–∏–∫–∞–ª–∏–∑–∞—Ü–∏—è –µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫–∞ (–¥–ª—è –≤—Å–µ—Ö —Å–æ–æ–±—â–µ—Å—Ç–≤)
    message_to_send = doReplacements( get_text() )

    # –ø–æ—Å—Ç–∏–Ω–≥ –≤ –∫–∞–Ω–∞–ª "–°–≤–µ—Ç—Å–∫–∏–π –µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫"
    chat_id = '@SecularNA'
    message_to_send = escape_system_text( escape_markdown_v2( message_to_send ) )
    #print( message_to_send )
    #return
    try:
        await bot.send_message(chat_id=chat_id, text=message_to_send, parse_mode='MarkdownV2')
        print( "–û—Ç–ø—Ä–∞–≤–∏–ª –ø–æ—Å—Ç –≤ –∫–∞–Ω–∞–ª –µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫–∞ üìò ‚úÖ" )
    except Exception as e:
        print( "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ—Å—Ç –≤ –∫–∞–Ω–∞–ª –µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫–∞ üìò ‚ùå" )
        print( "–û—à–∏–±–∫–∞:", e, " ‚öôÔ∏è \n" )

    #return
    # –ø–æ—Å—Ç–∏–Ω–≥ –≤ –∫–∞–Ω–∞–ª "–¢–∞–∫ –≥–æ–≤–æ—Ä–∏–ª –ë–∏–ª–ª"
    chat_id_3 = '@BillSpeaks'
    client = Client()

    attempts = 0
    while True:
        if attempts >= 20:
            print("–ü—Ä–µ–≤—ã—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è. –¶–∏–∫–ª –∑–∞–≤–µ—Ä—à–µ–Ω.")
            break
        
        role_system = """ –í—ã—Å–∫–∞–∂–∏—Å—å –ø–æ-—Ä—É—Å—Å–∫–∏, –ø–æ —Ç–µ–∫—Å—Ç—É, –≤ –¥—É—Ö–µ –ø—Å–∏—Ö–æ–ª–æ–≥–∏–∏. 
                          1-2 –Ω–µ–±–æ–ª—å—à–∏—Ö –∞–±–∑–∞—Ü–∞. –î–æ–±–∞–≤—å 3-5 —ç–º–æ–¥–∑–∏ –≤ —Ç–µ–∫—Å—Ç. """
        role_user = message_to_send

        completion = client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[ 
                {"role": "system", "content": role_system},
                {"role": "user", "content": role_user}
            ],
        )

        ai_response = escape_system_text( escape_markdown_v2( completion.choices[0].message.content ) )
        ai_response = "*__–í—ã—Å–∫–∞–∑—ã–≤–∞–Ω–∏–µ –ø–æ –∫–Ω–∏–≥–µ__* üó£Ô∏è \n\n" +ai_response

        # —É–¥–∞–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ –≤—ã–≤–æ–¥–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        ai_response = ai_response.replace(role_system, '')    
        ai_response = ai_response.replace('Assistant:', '')
        ai_response = ai_response.replace('assistant:', '')
        ai_response = ai_response.replace('–ö–æ–Ω–µ—Ü', '')
        ai_response = ai_response.replace('–∫–æ–Ω–µ—Ü', '')

        if has_glyphs(ai_response):
            print("has glyphs. try again... ‚öôÔ∏è")
            attempts += 1
            continue

        if role_user in ai_response:
            print("role_user in message. try again... ‚öôÔ∏è")
            attempts += 1
            continue

        if len( str(ai_response) ) < 250:
            print("too short response. try again... ‚öôÔ∏è")
            attempts += 1
            continue

        try:
            await bot.send_message( chat_id=chat_id_3, text=ai_response, parse_mode='MarkdownV2' )
            print( "–û—Ç–ø—Ä–∞–≤–∏–ª –ø–æ—Å—Ç –≤ –∫–∞–Ω–∞–ª –ë–∏–ª–ª–∞ –£–∏–ª—Å–æ–Ω–∞ üó£Ô∏è ‚úÖ" )
        except Exception as e:
            print( "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ—Å—Ç –≤ –∫–∞–Ω–∞–ª –ë–∏–ª–ª–∞ –£–∏–ª—Å–æ–Ω–∞ üó£Ô∏è ‚ùå" )
            print( "–û—à–∏–±–∫–∞:", e, " ‚öôÔ∏è \n" )
            #print( "–û—Ç–≤–µ—Ç –æ—Ç –ò–ò:", ai_response, " ‚öôÔ∏è \n" )
            attempts += 1
            continue
            
        break


    # –ø—Ä–∏–Ω—Ü–∏–ø—ã –ø—Ä–æ–≥—Ä–∞–º–º—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
    while True:
        if attempts >= 20:
            print("–ü—Ä–µ–≤—ã—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è. –¶–∏–∫–ª –∑–∞–≤–µ—Ä—à–µ–Ω.")
            break
        
        role_system = """ –ø—Ä–∏–Ω—Ü–∏–ø—ã –ø—Ä–æ–≥—Ä–∞–º–º—ã: —á–µ—Å—Ç–Ω–æ—Å—Ç—å, –Ω–µ–ø—Ä–µ–¥—É–±–µ–∂–¥–µ–Ω–Ω–æ—Å—Ç—å, –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å, —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ, 
                          –ø—Ä–∏–Ω—è—Ç–∏–µ, —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å, –¥–æ–≤–µ—Ä–∏–µ, –∫–∞–ø–∏—Ç—É–ª—è—Ü–∏—è, –Ω–∞–¥–µ–∂–¥–∞, –≤–µ—Ä–Ω–æ—Å—Ç—å –ø—Ä–∏–Ω—è—Ç–æ–º—É —Ä–µ—à–µ–Ω–∏—é, 
                          –º—É–∂–µ—Å—Ç–≤–æ, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å, —É–ø–æ—Ä—Å—Ç–≤–æ, –ø—Ä–∏–Ω—è—Ç–∏–µ —Å–µ–±—è, –ø—Ä–∏–∑–Ω–∞–Ω–∏–µ, —Ç–µ—Ä–ø–µ–Ω–∏–µ, —Å–æ—Å—Ç—Ä–∞–¥–∞–Ω–∏–µ, 
                          –ª—é–±–æ–≤—å, –ø—Ä–æ—â–µ–Ω–∏–µ, —Å–∞–º–æ–¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞, —á–∏—Å—Ç–æ—Å–µ—Ä–¥–µ—á–∏–µ, –±–µ—Å–∫–æ—Ä—ã—Å—Ç–∏–µ, –Ω–µ–ø–æ–∫–æ–ª–µ–±–∏–º–æ—Å—Ç—å. 
                          –ü—Ä–∏–≤–µ–¥–∏ 3 –ø—Ä–∏–Ω—Ü–∏–ø–∞ –ø–æ —Ç–µ–∫—Å—Ç—É, –Ω–∞–¥ –∫–æ—Ç–æ—Ä—ã–º–∏ —Å–µ–≥–æ–¥–Ω—è –Ω–∞–¥–æ —Ä–∞–±–æ—Ç–∞—Ç—å, –∏ –Ω–∞–ø–∏—à–∏ –ø–æ 
                          1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—é –æ–ø–∏—Å–∞–Ω–∏—è –Ω–∞ –∫–∞–∂–¥—ã–π. –†–∞–∑–¥–µ–ª–∏ —ç—Ç–∏ –ø—Ä–∏–Ω—Ü–∏–ø—ã –º–µ–∂—Å—Ç—Ä–æ—á–Ω—ã–º–∏ –æ—Ç—Å—Ç—É–ø–∞–º–∏ –∏ 
                          –æ–±–æ–∑–Ω–∞—á—å –∫–∞–∂–¥—ã–π –æ–¥–Ω–∏–º —ç–º–æ–¥–∑–∏. –ø–æ-—Ä—É—Å—Å–∫–∏. """
        role_user = message_to_send

        completion = client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[ 
                {"role": "system", "content": role_system},
                {"role": "user", "content": role_user}
            ],
        )

        ai_response = escape_system_text( escape_markdown_v2( completion.choices[0].message.content ) )
        ai_response = "*__–ü—Ä–∏–Ω—Ü–∏–ø—ã –ø—Ä–æ–≥—Ä–∞–º–º—ã__* üå± \n\n" +ai_response

        if has_glyphs(ai_response):
            print("has glyphs. try again... ‚öôÔ∏è")
            attempts += 1
            continue

        if len( str(ai_response) ) < 250:
            print("too short response. try again... ‚öôÔ∏è")
            attempts += 1
            continue

        try:
            await bot.send_message( chat_id=chat_id_3, text=ai_response, parse_mode='MarkdownV2' )
            print( "–û—Ç–ø—Ä–∞–≤–∏–ª –ø—Ä–∏–Ω—Ü–∏–ø—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è üå± ‚úÖ" )
        except Exception as e:
            print( "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–Ω—Ü–∏–ø—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è üå± ‚ùå" )
            print( "–û—à–∏–±–∫–∞:", e, " ‚öôÔ∏è \n" )
            #print( "–û—Ç–≤–µ—Ç –æ—Ç –ò–ò:", ai_response, " ‚öôÔ∏è \n" )
            attempts += 1
            continue
            
        break


    # —Ç–µ–º—ã –¥–ª—è —Å–æ–±—Ä–∞–Ω–∏—è
    while True:
        if attempts >= 20:
            print("–ü—Ä–µ–≤—ã—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è. –¶–∏–∫–ª –∑–∞–≤–µ—Ä—à–µ–Ω.")
            break
        
        role_system = """ –ü—Ä–∏–¥—É–º–∞–π 2 —Ç–µ–º—ã –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –∫–æ—Å–≤–µ–Ω–Ω–æ –ø–µ—Ä–µ–∫–ª–∏–∫–∞—é—Ç—Å—è —Å —Ç–µ–∫—Å—Ç–æ–º, 
                          –Ω–æ –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—é—Ç –µ–≥–æ. –†–∞–∑–¥–µ–ª–∏ —ç—Ç–∏ –ø—Ä–∏–Ω—Ü–∏–ø—ã –º–µ–∂—Å—Ç—Ä–æ—á–Ω—ã–º–∏ –æ—Ç—Å—Ç—É–ø–∞–º–∏ –∏ 
                          –æ–±–æ–∑–Ω–∞—á—å –∫–∞–∂–¥—ã–π –æ–¥–Ω–∏–º —ç–º–æ–¥–∑–∏. –ø–æ-—Ä—É—Å—Å–∫–∏. """
        role_user = message_to_send

        completion = client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[ 
                {"role": "system", "content": role_system},
                {"role": "user", "content": role_user}
            ],
        )

        ai_response = escape_system_text( escape_markdown_v2( completion.choices[0].message.content ) )
        ai_response = "*__–¢–µ–º—ã –¥–ª—è —Å–æ–±—Ä–∞–Ω–∏–π__* üìå \n\n" +ai_response

        if has_glyphs(ai_response):
            print("has glyphs. try again... ‚öôÔ∏è")
            attempts += 1
            continue

        if len( str(ai_response) ) < 250:
            print("too short response. try again... ‚öôÔ∏è")
            attempts += 1
            continue

        try:
            await bot.send_message( chat_id=chat_id_3, text=ai_response, parse_mode='MarkdownV2' )
            print( "–û—Ç–ø—Ä–∞–≤–∏–ª —Ç–µ–º—ã –¥–ª—è —Å–æ–±—Ä–∞–Ω–∏–π üìå ‚úÖ" )
        except Exception as e:
            print( "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–º—ã –¥–ª—è —Å–æ–±—Ä–∞–Ω–∏–π üìå ‚ùå" )
            print( "–û—à–∏–±–∫–∞:", e, " ‚öôÔ∏è \n" )
            #print( "–û—Ç–≤–µ—Ç –æ—Ç –ò–ò:", ai_response, " ‚öôÔ∏è \n" )
            attempts += 1
            continue
            
        break
    

    # –∑–∞–¥–∞–Ω–∏–µ –Ω–∞ –¥–µ–Ω—å
    while True:
        if attempts >= 20:
            print("–ü—Ä–µ–≤—ã—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è. –¶–∏–∫–ª –∑–∞–≤–µ—Ä—à–µ–Ω.")
            break
        
        role_system = """ –ü—Ä–∏–¥—É–º–∞–π 3 –¥–µ–π—Å—Ç–≤–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å, –∫–æ—Ç–æ—Ä—ã–µ —è –º–æ–≥—É —Å–¥–µ–ª–∞—Ç—å, 
                          —á—Ç–æ–±—ã —Å–ª–µ–¥–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç—É. –†–∞–∑–¥–µ–ª–∏ —ç—Ç–∏ –ø—Ä–∏–Ω—Ü–∏–ø—ã –º–µ–∂—Å—Ç—Ä–æ—á–Ω—ã–º–∏ –æ—Ç—Å—Ç—É–ø–∞–º–∏ –∏ 
                          –æ–±–æ–∑–Ω–∞—á—å –∫–∞–∂–¥—ã–π –æ–¥–Ω–∏–º —ç–º–æ–¥–∑–∏. –ø–æ-—Ä—É—Å—Å–∫–∏. """
        role_user = message_to_send

        completion = client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[ 
                {"role": "system", "content": role_system},
                {"role": "user", "content": role_user}
            ],
        )

        ai_response = escape_system_text( escape_markdown_v2( completion.choices[0].message.content ) )
        ai_response = "*__–ó–∞–¥–∞–Ω–∏–µ –Ω–∞ –¥–µ–Ω—å__* üìù \n\n" +ai_response

        if has_glyphs(ai_response):
            print("has glyphs. try again... ‚öôÔ∏è")
            attempts += 1
            continue

        if len( str(ai_response) ) < 250:
            print("too short response. try again... ‚öôÔ∏è")
            attempts += 1
            continue

        try:
            await bot.send_message( chat_id=chat_id_3, text=ai_response, parse_mode='MarkdownV2' )
            print( "–û—Ç–ø—Ä–∞–≤–∏–ª –∑–∞–¥–∞–Ω–∏–µ –Ω–∞ –¥–µ–Ω—å üìù ‚úÖ" )
        except Exception as e:
            print( "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ –Ω–∞ –¥–µ–Ω—å üìù ‚ùå" )
            print( "–û—à–∏–±–∫–∞:", e, " ‚öôÔ∏è \n" )
            #print( "–û—Ç–≤–µ—Ç –æ—Ç –ò–ò:", ai_response, " ‚öôÔ∏è \n" )
            attempts += 1
            continue
            
        break

    
    print( "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫:", (attempts + 1) )
    print( "success!" )

asyncio.run(main())
